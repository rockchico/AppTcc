
<!doctype html>

<html lang="en">
<head>

    <title>TESTE WASM</title>

    <style>
        #webcam {
            position: absolute;
            left: 0;
            top: 0;
        }

        #canvas {
            left: 0;
            top: 480px;
            position: absolute;
        }

        #canvas2 {
            left: 0;
            top: 0;
            position: absolute;
        }
    </style>


</head>
<body>
<video id="webcam" width="640" height="480" style="display:none;"></video>
<div style=" width:640px;height:480px;margin: 10px auto;">
    <canvas id="canvas" width="640" height="480"></canvas>
    <canvas id="canvas2" width="640" height="480"></canvas>
    <div id="no_rtc" class="alert alert-error" style="display:none;"></div>
    <div id="log" class="alert alert-info"></div>
</div>

<script type="text/javascript">

    //    wasmBinaryFile='https://192.168.99.10/AppTcc/www/testes/teste-wasm/color_cycle_asm.wasm';
    // https://10.1.0.3/AppTcc/www/testes/teste-wasm/color_cycle_asm.wasm

    var wasmURL = 'https://10.1.0.3/AppTcc/www/testes/teste-wasm/color_cycle_asm.wasm';

</script>



<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="compatibility.js"></script>
<script type="text/javascript" src="profiler.js"></script>

<script type="text/javascript" src='color_cycle_asm.js'></script>

<script type="text/javascript">





    $(window).load(function() {
        "use strict";

        var stat = new profiler();

        // lets do some fun
        var video = document.getElementById('webcam');
        var canvas = document.getElementById('canvas');
        var canvas2 = document.getElementById('canvas2');
        try {
            var attempts = 0;
            var readyListener = function(event) {
                findVideoSize();
            };
            var findVideoSize = function() {
                if(video.videoWidth > 0 && video.videoHeight > 0) {
                    video.removeEventListener('loadeddata', readyListener);
                    onDimensionsReady(video.videoWidth, video.videoHeight);
                } else {
                    if(attempts < 10) {
                        attempts++;
                        setTimeout(findVideoSize, 200);
                    } else {
                        onDimensionsReady(640, 480);
                    }
                }
            };
            var onDimensionsReady = function(width, height) {
                demo_app(width, height);
                compatibility.requestAnimationFrame(tick);
            };

            video.addEventListener('loadeddata', readyListener);

            // 0dbcc35221ffd40cb0d5eb6024f427f9b50da577a838739d963529ae71cfda8f
            // e6cb32e3da6356f1c650fd7136b2cbfa6f1a76950a69326baab56b6f8da3c346

            var teste123 = {video: {
                //facingMode: {exact: "environment"},
                //deviceId: {exact: "e6cb32e3da6356f1c650fd7136b2cbfa6f1a76950a69326baab56b6f8da3c346"},
                width: {exact: 640},
                height: {exact: 480}
            }};

            compatibility.getUserMedia(teste123, function(stream) {
                try {
                    video.src = compatibility.URL.createObjectURL(stream);
                } catch (error) {
                    video.src = stream;
                }
                setTimeout(function() {
                    video.play();
                }, 500);
            }, function (error) {
                $('#canvas').hide();
                $('#log').hide();
                $('#no_rtc').html('<h4>WebRTC not available.</h4>');
                $('#no_rtc').show();
            });
        } catch (error) {
            $('#canvas').hide();
            $('#log').hide();
            $('#no_rtc').html('<h4>Something goes wrong...</h4>');
            $('#no_rtc').show();
        }

        var stat = new profiler();
        var ctx, ctx2;

        function demo_app(videoWidth, videoHeight) {

            stat.add("rotate_color");

            ctx = canvas.getContext('2d');
            ctx2 = canvas2.getContext('2d');

            makeFrameProcessor();





        }


        function tick() {
            compatibility.requestAnimationFrame(tick);
            stat.new_frame();
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                ctx2.drawImage(video, 0, 0, 640, 480);
                //var imageData = ctx.getImageData(0, 0, 640, 480);

                //console.log(stat.log());


            }
        }













        $(window).unload(function() {
            video.pause();
            video.src=null;
        });
    });
</script>
</body>
</html>
